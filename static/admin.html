<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" /> 
		<title>小调查后台管理</title> 
		<script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
		<script type="text/javascript" src="js/common.js"></script> 
		<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
		<style type="text/css">
			input{margin-top: 10px;border-radius: 5px;width:400px}
			*{margin:0;padding:0;font-size: 16px;box-sizing: border-box;} 
			body{width: 100%;height: 100%}
			.inputdetails input{width: 20px}
			.leftbar{width: 20vw;height: auto;display: inline-block;border-right: 1px solid #e5e5e5}
			.leftbar div div{border-bottom: 1px solid #e5e5e5;padding: 10px}
			.leftbar btn-danger{width: 20px}
			.main_box{width:70vw;display: inline-block;vertical-align: top}
			.dele{font-size: 10px;width: 15px;height: 15px;line-height: 15px;text-align: center;position: relative;top: -5px;float: right;color:white;cursor: pointer;background: red;border-radius: 50%;}
			.detail input{width: 50px}
			.detail textarea{width: 300px}
			.detail {border: 1px solid #e5e5e5;border-radius: 5px;width: 400px;padding: 5px}
			.quslist div{cursor: pointer;}
			.inputdetails input{ width: 40px }
			.qustion{border: 1px solid #e5e5e5 ;border-radius: 5px;padding: 6px}
			.form-control{display: inline-block;}
		</style>
	</head>
	<body>
	<div class="leftbar">
		<div style="text-align: center;border-bottom: 1px solid #ddd;padding: 10px 0">测试标题</div>
		<div class="quslist"></div> 
		<button id="add"  type="button" class="btn btn-info" style="width: 100%">新增测试</button><br> 
	</div>
	<div class="main_box">
		<div class="input-group form-group">

			 问卷名称：
			<input  id="testtitle"  class="form-control" type="text" placeholder="请输入测试名称" name=""> <br>
			<!-- 编号：<input  type="text" maxlength="2" id="pid" style="width: 30px"> <br> -->
			编号 :<cite id="pid"></cite>
			<textarea name="" style="margin-top: 20px"  class="form-control" id="jj" placeholder="问卷简介" cols="70" rows="8"></textarea><br/>
			<form method="post" action="/uploadfile" id="form1" enctype="multipart/form-data" >
					
				封面图： <span id="pictitle"></span>
				<input type="file" id="pic" name="pic" placeholder="封面图" />
			</form>
		</div>
		<div class="list">
			
			<div class="form-group qustion" id="qus">
					<label for="">第<span class="num">1</span>题：</label>
					<input class="qustitle form-control" type="text" placeholder="请输入测试名称" name=""><br>
					A:<input type="tel"  class="qusans form-control" name=""> <br>
					B:<input type="tel"   class="qusans form-control" name=""> <br>
					C:<input type="tel" class="qusans form-control" name=""> <br>
					D:<input type="text"  class="qusans form-control"   name=""> <br>

				<div class=" inputdetails form-group ">
							每项得分(1,2,3,4)：

						A：<input type="text" co="A" maxlength="1"  class="form-control" name="">
						B：<input type="text" co="B" maxlength="1"  class="form-control" name="">
						C：<input type="text" co="C" maxlength="1"  class="form-control" name="">
						D：<input type="text" co="D" maxlength="1"  class="form-control" name="">

				</div>
			<button   type="button" class="btn delequs btn-danger">删除此项</button>
			</div> 
		</div> 

		<button id="next"  type="button" class="btn btn-info">下一题</button><br>
		 测试结果
		 <div id="anslist">
		 <div class="detail form-group" id="ansde">	
			<input type="text" class="form-control" maxlength="3" type="number" >至 <input maxlength="3" t class="form-control" type="text"  type="number" > <br>
			 <textarea class="form-control" style="margin-top:20px"></textarea> <br>
			<button  id="delethis"  type="button" class="btn btn-danger">删除此项</button>
		 </div>
		 	
		 </div>
		
		<button id="nextans"  type="button" class="btn btn-info">增加结果</button><br> 
		  

		<button id="nextans"  type="button" style="margin-top: 50px;width: 150px" onclick="addTest()" class="btn btn-success">提交</button><br> 
		</div>
	</div>	
	</body> 
	<script type="text/javascript">
		var qus=$("#qus").clone();
		var ansde=$("#ansde").clone()
		var num=1;
		var qust=[];
		var ans=[];
		var detail=[];
		var trueans=[];
		var ansdetext=[];
		var ansdeqj=[];
		var pid="";
		var firstpid=0
		var pic=""
		var Id=GetQueryString("id");
		if(Id!=undefined){
			getDate(Id)
		}
		getList()

		$("#next").click(function(){
			num=num+1 ;
			qus.find(".num").html(num);
			var newqus=qus.clone();
			$(".list").append(newqus) 
		})

		$("#nextans").click(function(){  
			var newansde=ansde.clone();
			$("#anslist").append(newansde) 
		})
		$(".quslist").on("click","div",function(){
			pid=$(this).attr("pid")
			getDate(pid);
		})
		$("#anslist").on("click","#delethis",function(){
			$(this).parent().remove()
		})
		$(".list").on("click",".delequs",function(e){
			e.stopPropagation(); 
			$(this).parent().remove()
		}) 
		$(".quslist").on("click","span",function(e){
			e.stopPropagation();
			pid=$(this).parent().attr("pid")
			remove(pid);
			pid=firstpid;
			$(this).parent().remove()
		}) 
		$("#pic").change(function(){
			upfile()
		})
	function upfile(){ 
		var formData= new FormData($("#form1")[0])
	     $.ajax({  
	          url: 'uploadfile' ,  
	          type: 'POST',  
	          data: formData,  
	          contentType:false,
	          processData:false, 
	          success: function (data) {  

	          		pic=data.data.path
	              //console.log(returndata);  
	          },  
	          error: function (returndata) {  
	              console.log(returndata);  
	          }  
	     });  
		}
		$("#add").click(function(){
			pid=firstpid
			var newqus=qus.clone();
			var newansde=ansde.clone();
			$(".list").empty()
			$("#jj").val("")
			$("#pictitle").html(" ")
			$(".list").append(newqus)
			$("#anslist").empty()       
			$("#anslist").append(newansde)
			$("#testtitle").val("");
			$("#pid").html("")
		})
		function getDate(pid){
			$.ajax({
				        type:"post",
				        url:"gettest",
				        data:{
				        	pid:pid,
						},
				        dataType:"json",
				        success:function(data) {  
				        	console.log(data)
							$("#testtitle").val(data.data.title)
							$(".list").empty()
							$("#jj").val(data.data.jj)
							$("#anslist").empty()
							$("#pid").html(data.data.pid)
							$("#pictitle").html(data.data.pic)
							//var picpath=
							pic=data.data.pic
							var length=data.data.content.length;
							for(var i=0;i<length;i++){

								var newqus=qus.clone();
								newqus.find(".qustitle").val(data.data.content[i]);
								newqus.find(".num").html(i+1)
								num=data.data.content.length
								for(var n=0;n<4;n++){ 
									newqus.find(".qusans").eq(n).val(data.data.answer[i][n])
								} 
									newqus.find(".inputdetails").find("input").eq(0).val(data.data.trueans[i][["A"]])
									newqus.find(".inputdetails").find("input").eq(1).val(data.data.trueans[i][["B"]])
									newqus.find(".inputdetails").find("input").eq(2).val(data.data.trueans[i][["C"]])
									newqus.find(".inputdetails").find("input").eq(3).val(data.data.trueans[i][["D"]])
								$(".list").append(newqus)
							}
							for(var j=0;j<data.data.ansdetext.length;j++){
								var newansde=ansde.clone();
								newansde.find("textarea").val(data.data.ansdetext[j])
								for(var k=0;k<2;k++){
									newansde.find("input").eq(k).val(data.data.ansdeqj[j][k])
								}
								$("#anslist").append(newansde)
							}
				        },
				        error:function(e) { 
				        	console.log(e)
				        }
			});
		}
		function remove(pid){
			$.ajax({
				        type:"post",
				        url:"remtest", 
				        dataType:"json",
				        data:{
				        	pid:pid,
						},
				        success:function(data) {
				        	console.log(data)
				        	alert("删除成功")
				        	$(this).parent().remove();
				        },
				        error:function(e) { 
				        	console.log(e)
				        }
			});
		}
		function getList(){
			$.ajax({
				        type:"get",
				        url:"getlist", 
				        dataType:"json",
				        success:function(data) {  
				        	for(var i=0;i<data.data.length;i++){
				        		if(firstpid<data.data[i].pid) firstpid=data.data[i].pid;
				        		console.log(firstpid)
				        		var span=$("<span>")
				        		span.html("x")
				        		span.attr("class","dele")
				        		var Div=$("<div>")
				        		Div.html(data.data[i].title)
				        		Div.attr("pid",data.data[i].pid)
				        		Div.append(span)
				        		$(".quslist").append(Div)
				        	} 
				        	firstpid=firstpid+1;
				        	pid=firstpid
				        },
				        error:function(e) { 
				        	console.log(e)
				        }
			});
		}
		function addTest(){  
			for(var i=0;i<$("input").length;i++){
				if($("input").eq(i).val()==""){
					if($("#pictitle").html()!=""){
						if($("input").eq(i).attr("id")=="pic"){
							continue
						}
					}
					alert("不得有空项！")
					return false
					break; 
				}
			}
			 qust=[];
			 ans=[];
			 detail=[]; 
			 ansdetext=[]
			 ansdeqj=[]	 
			var title=$("#testtitle").val();
			var jj=$("#jj").val();
			var num=0;
			var  time=new Date();
			$(".qustion").map(function(){
				if($(this).find(".qustitle").val()!=""){
					qust.push($(this).find(".qustitle").val());
					var ansc=[];
					$(this).find(".qusans").map(function(){
						ansc.push($(this).val())
					})  
					var tans={};
					$(this).find(".inputdetails").find("input").map(function(){
						var Co=$(this).attr("co")
						tans[Co]=$(this).val()
					})
					ans.push(ansc) 
					detail.push(tans)
					console.log(ansdeqj)
					num=num+1;
				}
			}) 

					$(".detail").map(function(){
						var qj=[];
						qj.push($(this).find("input").eq(0).val());
						qj.push($(this).find("input").eq(1).val())
						var text=$(this).find("textarea").val();
						ansdetext.push(text);
						ansdeqj.push(qj)
					})
			$.ajax({
				        type:"post",
				        url:"addtest",
				        data:{
				        	pid:pid,
							title:title,
							num:num,
							time:time,
							detail:detail,
							content:qust,
							answer:ans,
							ansdetext:ansdetext,
							ansdeqj:ansdeqj,
							jj:jj,
							pic:pic
						},
				        dataType:"json",
				        success:function(data) {
				        	console.log(data)
				        	alert("提交成功,问卷编号为  pid："+pid)
				        	window.location.href="admin.html"
				        },
				        error:function(e) { 
				        	console.log(e)
				        }
			});
		}
	</script>
</html>
